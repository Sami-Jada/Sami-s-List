#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Fast pre-commit checks
set -e

# Get staged files, excluding ignored files and common non-source directories
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | \
  grep -vE '^(node_modules|dist|build|\.expo|coverage|\.next|out|\.cache)/' | \
  grep -E '\.(ts|tsx|js|jsx|json|env|yaml|yml|md|txt|sh|py|java|go|rs|php|rb)$|^[^/]+$' || true)

# Early exit if no relevant files staged
if [ -z "$STAGED_FILES" ]; then
  echo "✅ Pre-commit checks passed (no relevant files to check)"
  exit 0
fi

# Quick check: .env files (fastest check first)
if echo "$STAGED_FILES" | grep -qE '\.env$|\.env\.'; then
  echo "❌ .env files should not be committed!"
  echo "Files: $(echo "$STAGED_FILES" | grep -E '\.env$|\.env\.')"
  exit 1
fi

# Fast secret detection: only check source files, use -l to stop at first match
if echo "$STAGED_FILES" | grep -E '\.(ts|tsx|js|jsx|json|sh|py|java|go|rs|php|rb)$' | \
   xargs -r grep -lE "(password|secret|key|token|api_key|private_key|access_token|refresh_token)\s*=\s*['\"][^'\"]{8,}" 2>/dev/null; then
  echo "❌ Potential secrets detected in staged files!"
  echo "Please remove any secrets before committing."
  exit 1
fi

echo "✅ Pre-commit checks passed"





